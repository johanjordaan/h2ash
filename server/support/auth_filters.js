// Generated by CoffeeScript 1.6.3
(function() {
  var admin_auth, auth, dbs, do_auth, errors;

  errors = require('./errors');

  dbs = {};

  do_auth = function(req, res, next, admin) {
    console.log("Running auth... [admin=" + admin + "] " + req.body.auth_email);
    if ((req.body.auth_token == null) || req.body.auth_token === "") {
      console.log('Here');
      res.json(errors.NOT_AUTHED);
      return;
    }
    if ((req.body.auth_email == null) || req.body.auth_email === "") {
      console.log('Here 2');
      res.json(errors.NOT_AUTHED);
      return;
    }
    return dbs.h2ash_auth.User.findOne({
      email: req.body.auth_email,
      token: req.body.auth_token
    }).exec(function(err, user) {
      if ((!err) && (user != null)) {
        console.log('Found ...');
        if (admin && !user.admin) {
          console.log('Admin right required');
          res.json(errors.NOT_AUTHED);
          return;
        }
        return user.generate_token(function() {
          return user.save(function(err, saved) {
            req.auth_user = saved;
            return next();
          });
        });
      } else {
        console.log('Not Found ...');
        return res.json(errors.NOT_AUTHED);
      }
    });
  };

  auth = function(req, res, next) {
    return do_auth(req, res, next, false);
  };

  admin_auth = function(req, res, next) {
    return do_auth(req, res, next, true);
  };

  module.exports = function(app_dbs) {
    var x;
    dbs = app_dbs;
    return x = {
      auth: auth,
      admin_auth: admin_auth
    };
  };

}).call(this);
